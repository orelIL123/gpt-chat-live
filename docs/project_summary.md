# סיכום פרויקט הצ'אטבוט - עדכונים ואופן הפעלה

מסמך זה מסכם את השינויים האחרונים שבוצעו בפרויקט הצ'אטבוט ואת אופן השימוש ברכיבים המעודכנים.

## 1. סיכום השינויים שבוצעו

בוצעו שינויים בשני רכיבים עיקריים:

*   **ווידג'ט הצ'אט (`public/widget.js`):**
    *   הווידג'ט עודכן לקרוא את ה-`clientId` תחילה מפרמטר ב-URL (לדוגמה: `?clientId=shira_tours`). אם לא נמצא ב-URL, הוא יחזור לקרוא אותו מהתכונה `data-client-id` בתגית הסקריפט של הווידג'ט.
    *   נוסף קישור דינמי "מעבר לאדמין" לכותרת חלון הצ'אט, שמפנה לכתובת `https://admin.chatvegosai.app/client/[clientId]` (כאשר `[clientId]` מוחלף ב-ID של הלקוח הנוכחי). הקישור מופיע רק אם נמצא `clientId`.
    *   כל הודעה שנשלחת בווידג'ט נשלחת כעת גם ל-Webhook הקיים ב-n8n בכתובת `https://chatvegosai.app.n8n.cloud/webhook/4a467811-bd9e-4b99-a145-3672a6ae6ed2/chat`.

*   **מסך ניהול בסיסי (`admin/index.html`):**
    *   נוצר קובץ HTML בסיסי למסך ניהול בנתיב `admin/index.html`.
    *   שולבו בו פרטי ההתחברות לפרויקט Firebase שלך כדי לאפשר טעינת נתונים.
    *   הדף מציג רשימה של לקוחות (מתוך אוסף `brains` ב-Firebase).
    *   בחירת לקוח מציגה את פרטיו (כרגע רק ID ומייל לידים) ואת היסטוריית ההודעות שלו (מתוך אוסף `leads` ב-Firebase).
    *   נוסף אזור "פקודות אדמין" עם תיבת טקסט להזנת הנחיה ל-AI וכפתור לשליחת פקודה.

*   **זרימת עבודה ב-n8n:**
    *   סופק JSON של זרימת עבודה מעודכנת ב-n8n (שם מומלץ: "Chatbot Workflow (Regular + Admin Email)").
    *   זרימה זו משתמשת באותו Webhook ID קיים (`4a467811-bd9e-4b99-a145-3672a6ae6ed2`).
    *   היא כוללת לוגיקה (באמצעות צומת IF) להבדיל בין הודעות צ'אט רגילות (שמגיעות מהווידג'ט) לבין פקודות אדמין (שמגיעות מהדשבורד ומכילות שדה `adminPrompt`).
    *   פקודות אדמין מנותבות למסלול שמשתמש ב-AI (מודל שפה) כדי ליצור נושא ותוכן למייל על סמך הנחיית האדמין, ושולח את המייל באמצעות צומת Gmail.

## 2. אופן הפעלת הרכיבים

### 2.1 הפעלת ווידג'ט הצ'אט המעודכן

1.  **Deploy לפרויקט:** וודא שביצעת Commit ו-Push של השינויים האחרונים (כולל העדכונים ב-`public/widget.js` וב-`.gitignore`) למאגר ה-Git המחובר ל-Vercel. Vercel יבצע Deploy אוטומטי.
2.  **הטמעת הווידג'ט:** השתמש בקוד ההטמעה של הווידג'ט בדף ה-HTML שלך. וודא שתגית הסקריפט כוללת את ה-`data-client-id` המתאים, או הוסף את פרמטר ה-`clientId` ל-URL של הדף.
3.  **בדיקה:** פתח את הדף בדפדפן. וודא שהווידג'ט מופיע, שה-`clientId` נקרא נכון (בדוק בקונסול הדפדפן), שהקישור "מעבר לאדמין" מופיע (אם יש `clientId`), וששליחת הודעות בצ'אט גורמת לקבלת נתונים ב-Webhook ב-n8n.

### 2.2 הפעלת מסך הניהול (הדשבורד)

1.  **Deploy לפרויקט:** וודא שביצעת Commit ו-Push של השינויים האחרונים (כולל העדכונים ב-`admin/index.html` וב-`.gitignore`) למאגר ה-Git המחובר ל-Vercel.
2.  **עדכון כתובת ה-Webhook:** **שלב קריטי!** עליך לערוך ידנית את הקובץ `admin/index.html` (במחשב שלך או ישירות בממשק ה-Git/Vercel אם אפשרי) ולהחליף את הכתובת בתוך הגרשים בשורה הבאה:
    ```javascript
    const ADMIN_COMMAND_WEBHOOK_URL = 'https://chatvegosai.app.n8n.cloud/webhook/4a467811-bd9e-4b99-a145-3672a6ae6ed2/chat'; // <-- REPLACE with the ACTUAL URL of your NEW n8n webhook for admin commands!
    ```
    החלף את הכתובת הנוכחית בכתובת ה-URL **האמיתית** של ה-Webhook ה**חדש** שיצרת ב-n8n עבור זרימת העבודה של פקודות האדמין (זו שמשתמשת ב-AI).
3.  **Deploy מחודש (אם עדכנת ידנית):** אם עדכנת את הקובץ `admin/index.html` ידנית לאחר ה-Push האחרון, בצע Commit ו-Push נוספים כדי שהשינוי הזה יעלה ל-Vercel.
4.  **גישה לדשבורד:** פתח את הדפדפן ונווט לכתובת ה-URL של ה-Deploy שלך ב-Vercel בתוספת הנתיב לקובץ: `https://[YOUR_VERCEL_DEPLOYMENT_URL]/admin/index.html`.
5.  **בדיקה:**
    *   וודא שרשימת הלקוחות נטענת מ-Firebase.
    *   בחר לקוח מהרשימה. וודא שפרטיו והודעותיו נטענים.
    *   הזן הנחיה באזור "פקודות אדמין".
    *   לחץ על "שלח פקודה ל-n8n".
    *   בדוק בלוגים של זרימת העבודה ב-n8n (הזרימה המעודכנת). וודא שהבקשה הגיעה, שהיא נותבה למסלול ה"אמת" (True), שה-AI יצר נושא ותוכן למייל, ושצומת ה-Gmail ניסה לשלוח את המייל.

### 2.3 הפעלת זרימת העבודה המעודכנת ב-n8n

1.  **ייבוא הזרימה:** השתמש ב-JSON של זרימת העבודה המעודכנת שסיפקתי קודם. בממשק ה-n8n שלך, צור זרימת עבודה חדשה וייבא את ה-JSON.
2.  **הפעלת הזרימה:** הפעל את זרימת העבודה החדשה שיצרת (לחץ על ה-Toggle בפינה הימנית העליונה).
3.  **בדיקה:** וודא שהזרימה פעילה. בדוק בלוגים של ה-Webhook כדי לראות בקשות נכנסות (מהווידג'ט או מהדשבורד) ועקוב אחר המסלול שהן עוברות בזרימה.

## 3. הערות חשובות

*   וודא שחשבון ה-Gmail המוגדר ב-n8n (בצומת ה-Gmail) מחובר כראוי ויש לו הרשאות לשלוח מיילים.
*   וודא שפרטי ההתחברות ל-Firebase בקובץ `admin/index.html` נכונים.
*   הדשבורד הוא בסיסי ומיועד לבדיקה ראשונית. ייתכן שיהיה צורך לשפר את ה-UI ואת הלוגיקה שלו בעתיד.
*   הלוגיקה של ה-AI בזרימת ה-n8n ליצירת תוכן המייל תלויה בהנחיה שניתנת לו. ייתכן שיהיה צורך לכוונן את ההנחיה בצומת ה-Function ב-n8n כדי לקבל תוצאות מיטביות.